name: Kick StegVerse Autopatch

on:
  workflow_dispatch: {}

jobs:
  kick:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve token
        id: token
        run: |
          # Prefer the classic PAT in PAT_WORKFLOW
          if [ -n "${{ secrets.PAT_WORKFLOW }}" ]; then
            echo "Using PAT_WORKFLOW"
            echo "token=${{ secrets.PAT_WORKFLOW }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.GH_STEGVERSE_PAT }}" ]; then
            # Optional fallback, but PAT_WORKFLOW is the main one
            echo "Using GH_STEGVERSE_PAT"
            echo "token=${{ secrets.GH_STEGVERSE_PAT }}" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Neither PAT_WORKFLOW nor GH_STEGVERSE_PAT is set"
            exit 1
          fi

      - name: Dispatch target workflow
        run: |
          set -euo pipefail
          echo "Dispatching auto_patch.yml on StegVerse-Labs/StegVerse-SCW@main"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ steps.token.outputs.token }}" \
            https://api.github.com/repos/StegVerse-Labs/StegVerse-SCW/actions/workflows/auto_patch.yml/dispatches \
            -d '{"ref":"main"}'
